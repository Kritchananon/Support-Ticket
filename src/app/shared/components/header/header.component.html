<!-- ‚úÖ Token Warning Bar -->
<div *ngIf="showTokenWarning" class="token-warning-bar">
  <span>‚ö†Ô∏è {{ getText('Your session will expire soon. Do you want to extend it?', '‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?') }}</span>
  <button (click)="refreshSession()" class="btn-refresh" [disabled]="isRefreshing">
    <span *ngIf="isRefreshing" class="spinner-border spinner-border-sm me-2"></span>
    {{ isRefreshing ? getText('Refreshing...', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏...') : getText('Extend Session', '‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô') }}
  </button>
  <button (click)="dismissWarning()" class="btn-dismiss">√ó</button>
</div>

<header class="header">
  <div class="header-content">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle d-md-none" (click)="toggleMobileMenu()">
      <i class="bi bi-list"></i>
    </button>

    <!-- ‚úÖ Role-Based Quick Actions (Left side) -->
    <div class="quick-actions d-none d-lg-flex">
      <ng-container *ngFor="let action of getVisibleQuickActions()">
        <button 
          *hasPermission="[action.permission]"
          (click)="navigateToQuickAction(action)"
          class="btn btn-sm me-2"
          [ngClass]="action.class"
          [title]="getMenuItemLabel(action)">
          <i [class]="action.icon"></i>
          <span class="d-none d-xl-inline ms-1">{{ getMenuItemLabel(action) }}</span>
        </button>
      </ng-container>
    </div>

    <!-- Page Title (Center - optional) -->
    <div class="page-title d-none d-md-block">
      <h4 class="mb-0">{{ pageTitle }}</h4>
    </div>

    <!-- Right Side Navigation -->
    <div class="header-nav ms-auto">
      <!-- ‚úÖ Role Badge -->
      <div class="role-badge me-3 d-none d-md-flex" *ngIf="currentUser">
        <span class="badge"
              [ngClass]="{
                'bg-danger': isAdmin(),
                'bg-warning': isSupporter(),
                'bg-primary': isUser()
              }">
          <i class="bi" 
             [ngClass]="{
               'bi-shield-check': isAdmin(),
               'bi-headset': isSupporter(),
               'bi-person': isUser()
             }"></i>
          {{ getRoleDisplay() }}
        </span>
      </div>

      <!-- ‚úÖ Notifications (Support team only) -->
      <div class="dropdown me-3" *hasRole="[ROLES.ADMIN, ROLES.SUPPORTER]">
        <button 
          class="btn-icon dropdown-toggle" 
          type="button" 
          data-bs-toggle="dropdown" 
          aria-expanded="false"
          [attr.aria-label]="getText('Notifications', '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô')">
          <i class="bi bi-bell"></i>
          <span *ngIf="hasUnreadNotifications()" class="notification-badge">
            {{ getNotificationCount() }}
          </span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end notification-menu">
          <li class="dropdown-header">
            {{ getText('Notifications', '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô') }}
            <button *ngIf="hasUnreadNotifications()" 
                    (click)="markNotificationsAsRead()" 
                    class="btn btn-sm btn-link float-end">
              {{ getText('Mark all as read', '‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') }}
            </button>
          </li>
          <li><hr class="dropdown-divider"></li>
          
          <!-- TODO: Add notification items -->
          <li class="dropdown-item-text text-center text-muted">
            {{ getText('No new notifications', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà') }}
          </li>
        </ul>
      </div>

      <!-- Language Selector -->
      <div class="dropdown me-3">
        <button 
          class="btn-outline-secondary dropdown-toggle language-btn" 
          type="button" 
          data-bs-toggle="dropdown" 
          aria-expanded="false"
          [attr.aria-label]="getText('Select Language', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤')">
          <span class="flag-emoji me-2">{{ currentLanguage === 'th' ? 'üáπüá≠' : 'üá∫üá∏' }}</span>
          {{ currentLanguage === 'th' ? 'TH' : 'EN' }}
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <button 
              class="dropdown-item" 
              type="button"
              (click)="switchLanguage('th')"
              [class.active]="currentLanguage === 'th'"
              [attr.aria-pressed]="currentLanguage === 'th'">
              <span class="flag-emoji me-2">üáπüá≠</span>
              ‡πÑ‡∏ó‡∏¢
            </button>
          </li>
          <li>
            <button 
              class="dropdown-item" 
              type="button"
              (click)="switchLanguage('en')"
              [class.active]="currentLanguage === 'en'"
              [attr.aria-pressed]="currentLanguage === 'en'">
              <span class="flag-emoji me-2">üá∫üá∏</span>
              English
            </button>
          </li>
        </ul>
      </div>

      <!-- User Dropdown -->
      <div class="dropdown">
        <button 
          class="btn-link dropdown-toggle user-dropdown" 
          type="button" 
          data-bs-toggle="dropdown" 
          aria-expanded="false"
          [attr.aria-label]="getText('User Menu', '‡πÄ‡∏°‡∏ô‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ')">
          <div class="user-avatar">
            <i class="bi bi-person-circle"></i>
          </div>
          <span class="user-name ms-2">
            {{ getGreeting() }}, {{ currentUser?.firstname || 'User' }}
          </span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end user-menu">
          <!-- User Info Header -->
          <li class="dropdown-header">
            <div class="user-info">
              <div class="user-avatar-large">
                <i class="bi bi-person-circle"></i>
              </div>
              <div class="user-details">
                <div class="user-name-full">{{ getUserFullName() }}</div>
                <div class="user-email">{{ getUserContact() || currentUser?.username }}</div>
                <div class="user-role-small">
                  <i class="bi" 
                     [ngClass]="{
                       'bi-shield-check': isAdmin(),
                       'bi-headset': isSupporter(),
                       'bi-person': isUser()
                     }"></i>
                  {{ getRoleDisplay() }}
                </div>
              </div>
            </div>
          </li>
          <li><hr class="dropdown-divider"></li>
          
          <!-- Profile Link -->
          <li>
            <a class="dropdown-item" href="#" (click)="goToProfile($event)">
              <i class="bi bi-person me-2"></i>
              {{ getText('My Profile', '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô') }}
            </a>
          </li>
          
          <!-- Settings Link -->
          <li>
            <a class="dropdown-item" href="#" (click)="goToSettings($event)">
              <i class="bi bi-gear me-2"></i>
              {{ getText('Settings', '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤') }}
            </a>
          </li>

          <!-- ‚úÖ Role-specific menu items -->
          <li><hr class="dropdown-divider"></li>
          
          <!-- Admin Panel (Admin only) -->
          <li *hasRole="[ROLES.ADMIN]">
            <a class="dropdown-item" [routerLink]="['/admin']">
              <i class="bi bi-shield-check me-2"></i>
              {{ getText('Admin Panel', '‡πÅ‡∏ú‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•') }}
            </a>
          </li>
          
          <!-- Support Panel (Support team only) -->
          <li *hasRole="[ROLES.ADMIN, ROLES.SUPPORTER]">
            <a class="dropdown-item" [routerLink]="['/support']">
              <i class="bi bi-headset me-2"></i>
              {{ getText('Support Panel', '‡πÅ‡∏ú‡∏á‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô') }}
            </a>
          </li>

          <!-- User Management (Admin only) -->
          <li *hasPermission="[permissionEnum.ADD_USER, permissionEnum.DEL_USER]">
            <a class="dropdown-item" [routerLink]="['/admin/users']">
              <i class="bi bi-people me-2"></i>
              {{ getText('User Management', '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ') }}
            </a>
          </li>

          <!-- Reports (Support team only) -->
          <li *hasRole="[ROLES.ADMIN, ROLES.SUPPORTER]">
            <a class="dropdown-item" [routerLink]="['/reports']">
              <i class="bi bi-graph-up me-2"></i>
              {{ getText('Reports', '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô') }}
            </a>
          </li>

          <li><hr class="dropdown-divider"></li>
          
          <!-- Logout Link -->
          <li>
            <a class="dropdown-item text-danger" href="#" (click)="logout($event)">
              <i class="bi bi-box-arrow-right me-2"></i>
              {{ getText('Logout', '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö') }}
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Mobile Menu (Role-based) -->
  <div class="mobile-menu d-md-none" *ngIf="isMobile()">
    <div class="mobile-menu-content">
      <div class="mobile-user-info">
        <div class="user-avatar">
          <i class="bi bi-person-circle"></i>
        </div>
        <div class="user-details">
          <div class="user-name">{{ getUserFullName() }}</div>
          <div class="user-role">{{ getRoleDisplay() }}</div>
        </div>
      </div>

      <!-- Mobile Navigation Menu -->
      <nav class="mobile-nav">
        <ng-container *ngFor="let item of getMenuItems()">
          <a 
            *hasPermission="item.permissions"
            [routerLink]="item.route"
            class="mobile-nav-item"
            [class.active]="isCurrentRoute(item.route)"
            [attr.aria-label]="getAriaLabel(item)">
            <i [class]="item.icon"></i>
            <span>{{ getMenuItemLabel(item) }}</span>
          </a>
        </ng-container>
      </nav>

      <!-- Mobile Quick Actions -->
      <div class="mobile-quick-actions">
        <ng-container *ngFor="let action of getVisibleQuickActions()">
          <button 
            *hasPermission="[action.permission]"
            (click)="navigateToQuickAction(action)"
            class="btn btn-sm"
            [ngClass]="action.class">
            <i [class]="action.icon"></i>
            <span>{{ getMenuItemLabel(action) }}</span>
          </button>
        </ng-container>
      </div>
    </div>
  </div>
</header>