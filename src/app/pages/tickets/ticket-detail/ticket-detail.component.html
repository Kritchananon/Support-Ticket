<!-- ===== SUCCESS MODAL ===== ‚úÖ -->
<div class="modal fade" [class.show]="showSuccessModal" [style.display]="showSuccessModal ? 'block' : 'none'"
  [style.z-index]="showSuccessModal ? '99999' : 'auto'" tabindex="-1" role="dialog" aria-labelledby="successModalLabel"
  aria-hidden="!showSuccessModal" *ngIf="showSuccessModal">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content success-modal">
      <div class="modal-body text-center">
        <!-- Success Icon -->
        <div class="success-icon-container">
          <div class="success-star">
            <i class="bi bi-star-fill"></i>
          </div>
        </div>

        <!-- Modal Title -->
        <h4 class="success-title">{{ modalTitle }}</h4>

        <!-- Ticket Number -->
        <p class="success-ticket-info">Ticket ID : {{ modalTicketNo }}</p>

        <!-- Success Message -->
        <p class="success-message">{{ modalMessage }}</p>

        <!-- Close Button -->
        <button type="button" class="btn btn-primary success-btn" (click)="closeSuccessModal()" autofocus>
          ‡∏ï‡∏Å‡∏•‡∏á
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showSuccessModal" [style.z-index]="showSuccessModal ? '99998' : 'auto'"
  *ngIf="showSuccessModal" (click)="closeSuccessModal()"></div>

<!-- ===== LOADING STATE ===== ‚úÖ -->
<div class="loading-container" *ngIf="isLoading">
  <div class="static-loading-indicator">
    <div class="loading-spinner"></div>
    <p class="static-loading-text">Loading ticket details...</p>
  </div>
</div>

<!-- ===== ERROR STATE ===== ‚úÖ -->
<div *ngIf="error && !isLoading" class="error-container">
  <div class="error-content">
    <i class="bi bi-exclamation-triangle error-icon"></i>
    <h3>{{ error }}</h3>
    <button class="btn btn-primary" (click)="backToList()">
      <i class="bi bi-arrow-left me-2"></i>
      Back to All Tickets
    </button>
  </div>
</div>

<!-- ===== MAIN CONTENT ===== ‚úÖ -->
<div *ngIf="ticketData && !isLoading" class="ticket-detail-page">

  <!-- ===== BREADCRUMB ===== ‚úÖ -->
  <div class="breadcrumb-container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a routerLink="/tickets">All Tickets</a>
        </li>
        <li class="breadcrumb-item">
          <a routerLink="/tickets">Ticket</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          Ticket {{ ticketData.ticket.ticket_no }}
        </li>
      </ol>
    </nav>
  </div>

  <!-- ===== LAYOUT CONTAINER ===== ‚úÖ -->
  <div class="layout-container">

    <!-- ===== MAIN CONTENT AREA ===== ‚úÖ -->
    <div class="main-content-area">

      <!-- ===== TICKET INFORMATION CARD ===== ‚úÖ -->
      <div class="ticket-card" [attr.data-updating]="isUpdating">

        <!-- Ticket Header -->
        <div class="ticket-header">
          <div class="ticket-header-left">
            <div class="ticket-title-container">
              <h1 class="ticket-title">Ticket {{ ticketData.ticket.ticket_no }}</h1>

              <!-- Status Badge -->
              <div class="status-badge" [ngClass]="getStatusBadgeClass()">
                <span *ngIf="isLoadingStatus" class="spinner-border spinner-border-sm me-1" role="status"></span>
                <i class="status-icon" [ngClass]="getStatusIcon()" *ngIf="!isLoadingStatus"></i>
                <span class="status-text">{{ getCurrentStatusName() }}</span>
                <i class="bi bi-exclamation-triangle text-warning ms-1" *ngIf="statusError && !isLoadingStatus"
                  [title]="statusError"></i>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="ticket-header-right">
            <div class="action-buttons">
              <!-- ‚úÖ Export PDF Dropdown Button -->
              <div class="dropdown me-2" *ngIf="hasPermission(1)">
                <button [class]="getExportButtonClass()" type="button" id="exportDropdown" data-bs-toggle="dropdown"
                  aria-expanded="false" [disabled]="!canExportPdf()" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF">

                  <span *ngIf="isExportingPdf" class="spinner-border spinner-border-sm me-1" role="status"></span>
                  <i class="bi bi-file-earmark-pdf me-1" *ngIf="!isExportingPdf"></i>
                  <span>{{ getExportButtonText() }}</span>
                  <i class="bi bi-chevron-down ms-1" *ngIf="!isExportingPdf"></i>
                </button>

                <ul class="dropdown-menu" aria-labelledby="exportDropdown" *ngIf="canExportPdf()">
                  <li>
                    <a class="dropdown-item" href="javascript:void(0)" (click)="exportSummaryPdf()">
                      <i class="bi bi-file-earmark-text me-2"></i>
                      Export Summary PDF
                      <small class="text-muted d-block">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</small>
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="javascript:void(0)" (click)="exportDetailedPdf()">
                      <i class="bi bi-file-earmark-richtext me-2"></i>
                      Export Detailed PDF
                      <small class="text-muted d-block">‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</small>
                    </a>
                  </li>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                  <li>
                    <a class="dropdown-item" href="javascript:void(0)" (click)="exportCustomPdf()">
                      <i class="bi bi-gear me-2"></i>
                      Custom Export
                      <small class="text-muted d-block">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‡∏ï‡∏≤‡∏° exportOptions</small>
                    </a>
                  </li>
                </ul>
              </div>

              <!-- ‚úÖ Delete Button with Enhanced Tooltip -->
              <button [class]="getDeleteButtonClass()" (click)="onDeleteTicket()"
                [disabled]="!canDelete() || isDeleting" [title]="getDeleteButtonTooltip()">

                <span *ngIf="isDeleting" class="spinner-border spinner-border-sm me-1" role="status"></span>
                <i class="bi bi-trash" *ngIf="!isDeleting"></i>
                <span *ngIf="!isDeleting">Delete</span>
                <span *ngIf="isDeleting">Deleting...</span>
              </button>

              <!-- ‚úÖ Edit Button with Enhanced Tooltip -->
              <button [class]="getEditButtonClass()" (click)="onEditTicket()" [disabled]="!canEdit() || isEditing"
                [title]="getEditButtonTooltip()">

                <span *ngIf="isEditing" class="spinner-border spinner-border-sm me-1" role="status"></span>
                <i class="bi bi-pencil" *ngIf="!isEditing"></i>
                <span>{{ getEditButtonText() }}</span>
              </button>

            </div>
          </div>
        </div>

        <!-- ‚úÖ Export Status Alert -->
        <div *ngIf="exportError" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Export Error:</strong> {{ exportError }}
          <button type="button" class="btn-close" (click)="exportError = ''" aria-label="Close"></button>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
          <div class="progress-fill"></div>
          <div class="progress-remaining"></div>
        </div>

        <!-- Ticket Details -->
        <div class="ticket-details">
          <div class="detail-item">
            <div class="detail-label">Ticket no:</div>
            <div class="detail-value">{{ ticketData.ticket.ticket_no }}</div>
          </div>

          <div class="detail-divider"></div>

          <div class="detail-item">
            <div class="detail-label">Priority:</div>
            <div class="detail-value priority-high">{{ ticketData.ticket.priority || 'Medium' }}</div>
          </div>

          <div class="detail-divider"></div>

          <div class="detail-item">
            <div class="detail-label">Categories:</div>
            <div class="detail-value">{{ ticketData.ticket.categories_name }}</div>
          </div>

          <div class="detail-divider"></div>

          <div class="detail-item">
            <div class="detail-label">Project:</div>
            <div class="detail-value">{{ ticketData.ticket.project_name }}</div>
          </div>
        </div>

        <!-- Issue Section -->
        <div class="issue-section">
          <div class="user-avatar">
            <div class="avatar-circle">
              <i class="bi bi-chat-dots-fill"></i>
            </div>
          </div>

          <div class="issue-content">
            <div class="issue-label">Issue Description:</div>
            <div class="issue-description">{{ ticketData.ticket.issue_description }}</div>
          </div>
        </div>

        <!-- Attachments Section -->
        <div class="attachments-section">
          <div class="attachment-label">
            <i class="bi bi-paperclip me-1"></i>
            Original Issue Attachments:
            <small class="text-muted">(‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á ticket)</small>
          </div>
          <div class="attachment-grid">

            <!-- Attachment Items -->
            <div *ngFor="let attachment of ticketData.issue_attachment" class="attachment-item"
              (click)="onDownloadAttachment(attachment.attachment_id, attachment.path)">

              <!-- Loading State -->
              <div class="attachment-loading" *ngIf="getFileInfo(attachment.attachment_id).isLoading">
                <i class="bi bi-hourglass-split"></i>
                <div class="loading-text">Analyzing...</div>
              </div>

              <!-- Image Preview -->
              <div class="attachment-preview"
                *ngIf="isImageFile(attachment.path, attachment.attachment_id) && !getFileInfo(attachment.attachment_id).isLoading">
                <img [src]="attachment.path" [alt]="getDisplayFileName(attachment.path, attachment.attachment_id)"
                  (error)="onImageError(attachment.attachment_id)" (load)="onImageLoad(attachment.attachment_id)"
                  loading="lazy" style="max-width: 100%; max-height: 200px; object-fit: cover; border-radius: 4px;">

                <div class="file-info-overlay">
                  <div class="file-name-small">{{ getDisplayFileName(attachment.path, attachment.attachment_id) }}</div>
                  <div class="file-size" *ngIf="getFileSize(attachment)">{{ getFileSize(attachment) }}</div>
                </div>
              </div>

              <!-- File Icon -->
              <div class="attachment-file"
                *ngIf="!isImageFile(attachment.path, attachment.attachment_id) && !getFileInfo(attachment.attachment_id).isLoading">

                <div class="file-icon-container">
                  <i [class]="getFileIcon(attachment.path, attachment.attachment_id)"
                    [ngClass]="'file-icon-' + getFileInfo(attachment.attachment_id).type"></i>
                </div>

                <div class="file-details">
                  <div class="file-name" [title]="getDisplayFileName(attachment.path, attachment.attachment_id)">
                    {{ getDisplayFileName(attachment.path, attachment.attachment_id) }}
                  </div>

                  <div class="file-meta">
                    <span class="file-type">{{ getFileInfo(attachment.attachment_id).type.toUpperCase() }}</span>
                    <span class="file-size" *ngIf="getFileSize(attachment)">{{ getFileSize(attachment) }}</span>
                  </div>
                </div>

                <div class="download-indicator">
                  <i class="bi bi-download"></i>
                </div>
              </div>
            </div>

            <!-- No attachments -->
            <div *ngIf="ticketData.issue_attachment.length === 0" class="no-attachments">
              <i class="bi bi-paperclip"></i>
              <span class="text-muted">No original attachments</span>
            </div>
          </div>
        </div>

        <!-- Ticket Footer -->
        <div class="ticket-footer">

          <!-- Reporter Information -->
          <div class="footer-section">
            <div class="footer-item">
              <div class="footer-label">Reporter:</div>
              <div class="footer-value">{{ ticketData.ticket.create_by }}</div>
            </div>
            <div class="footer-item">
              <div class="footer-label">Created:</div>
              <div class="footer-value">{{ formatDate(ticketData.ticket.create_date) }}</div>
            </div>
            <div class="footer-item">
              <div class="footer-label">Updated:</div>
              <div class="footer-value">{{ formatDate(ticketData.ticket.update_date) }}</div>
            </div>
          </div>

          <!-- ‚úÖ Enhanced Evaluation Section -->
          <div class="evaluation-section" *ngIf="hasSpecificPermission(14)">
            <div class="evaluation-label">Evaluation</div>

            <!-- Evaluation Status Message -->
            <div class="evaluation-status" *ngIf="(!canEvaluate || hasExistingSatisfaction) && getEvaluationMessage()"
              [ngClass]="{
                   'text-success': hasExistingSatisfaction,
                   'text-muted': !canEvaluate && !hasExistingSatisfaction
                 }">
              <small>{{ getEvaluationMessage() }}</small>
            </div>

            <!-- Star Rating -->
            <div class="star-rating">
              <div class="star" *ngFor="let i of [1,2,3,4,5]" [ngClass]="getStarClass(i)"
                (click)="canClickStar() ? setRating(i) : null" (mouseenter)="onStarMouseEnter(i)"
                (mouseleave)="onStarMouseLeave()" [title]="getStarTooltip(i)">

                <!-- Loading spinner ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
                <span *ngIf="isSavingRating && i === currentRating" class="spinner-border spinner-border-sm"
                  role="status"></span>

                <!-- Star icons -->
                <i *ngIf="!isSavingRating || i !== currentRating" class="bi" [ngClass]="{
                     'bi-star-fill': isStarFilled(i),
                     'bi-star': !isStarFilled(i)
                   }"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== ‚úÖ SUPPORT INFORMATION SECTION - ‡πÉ‡∏ä‡πâ Components ‡πÅ‡∏¢‡∏Å ===== -->

      <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Supporter/Admin) - ‡πÅ‡∏™‡∏î‡∏á Display Component -->
      <app-support-information-display *ngIf="!canShowForm()" [ticketData]="ticketData">
      </app-support-information-display>

      <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Supporter/Admin - ‡πÅ‡∏™‡∏î‡∏á Form Component -->
      <app-support-information-form *ngIf="canShowForm()" [ticketData]="ticketData" [ticket_no]="ticket_no"
        [isLoadingTicketData]="isLoading" (supporterDataSaved)="onSupporterDataSaved($event)"
        (ticketAssigned)="onTicketAssigned($event)" (refreshRequired)="onRefreshRequired()">
      </app-support-information-form>

    </div>

    <!-- ===== HISTORY SIDEBAR ===== ‚úÖ -->
    <div class="history-card">

      <!-- History Header -->
      <div class="history-header">
        <h2 class="history-title">History</h2>
        <div class="history-progress-bar">
          <div class="history-progress-fill"></div>
          <div class="history-progress-remaining"></div>
        </div>
      </div>

      <!-- Loading State for History -->
      <div *ngIf="isLoadingHistory" class="history-loading">
        <div class="loading-spinner-small">
          <span class="spinner-border spinner-border-sm"></span>
          <span class="text-muted ms-2">Loading history...</span>
        </div>
      </div>

      <!-- Status History Timeline -->
      <div *ngIf="!isLoadingHistory && displayHistory && displayHistory.length > 0" class="history-timeline">
        <div *ngFor="let historyItem of displayHistory; let i = index" class="history-item"
          [class.current-status]="historyItem.is_active" [class.completed-status]="historyItem.is_completed"
          [class.pending-status]="!historyItem.is_active && !historyItem.is_completed">

          <!-- History Badge -->
          <div class="history-badge" [ngClass]="getHistoryBadgeClass(historyItem)">
            <!-- ‚úÖ ‡∏™‡πà‡∏á status_id ‡πÅ‡∏ó‡∏ô status_name -->
            <i *ngIf="!isStatusSkipped(historyItem)" [class]="getHistoryIcon(historyItem.status_id)"></i>
          </div>

          <!-- History Content -->
          <div class="history-content">
            <div class="history-status" [class.active-status]="historyItem.is_active">
              {{ historyItem.status_name }}
            </div>

            <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ -->
            <div class="history-date" *ngIf="hasHistoryDate(historyItem)">
              {{ formatHistoryDate(historyItem.create_date) }}
            </div>

            <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á "-" ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤ (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞ completed ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà) -->
            <div class="history-date pending" *ngIf="!hasHistoryDate(historyItem)">
              <span class="text-muted">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- No History State -->
      <div *ngIf="!isLoadingHistory && (!displayHistory || displayHistory.length === 0)" class="no-history">
        <div class="text-center text-muted py-3">
          <i class="bi bi-clock-history fs-4"></i>
          <div class="mt-2">No history available</div>
        </div>
      </div>

      <!-- ‚úÖ Quick Actions Panel -->
      <div class="quick-actions mt-3">
        <div class="card">
          <div class="card-header">
            <small><i class="bi bi-lightning me-1"></i> Quick Actions</small>
          </div>
          <div class="card-body p-2">

            <!-- ‚úÖ User Actions - ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ -->
            <button class="btn btn-sm btn-outline-primary w-100 mb-1" (click)="loadTicketDetail()"
              title="Refresh ticket details" [disabled]="isLoading">
              <i class="bi bi-arrow-clockwise me-1"></i>
              <span *ngIf="!isLoading">Refresh</span>
              <span *ngIf="isLoading">Refreshing...</span>
            </button>

            <!-- ‚úÖ Export Actions - permission 1 (VIEW_TICKETS) -->
            <div *ngIf="hasPermission(1)" class="export-actions">
              <div class="btn-group w-100 mb-1" role="group">
                <button class="btn btn-sm btn-outline-info" (click)="exportSummaryPdf()" [disabled]="!canExportPdf()"
                  title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠">
                  <i class="bi bi-file-earmark-text me-1"></i>
                  <span *ngIf="!isExportingPdf">Summary PDF</span>
                  <span *ngIf="isExportingPdf">Exporting...</span>
                </button>

                <button class="btn btn-sm btn-outline-info" (click)="exportDetailedPdf()" [disabled]="!canExportPdf()"
                  title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                  <i class="bi bi-file-earmark-richtext me-1"></i>
                  <span *ngIf="!isExportingPdf">Detailed PDF</span>
                  <span *ngIf="isExportingPdf">Exporting...</span>
                </button>
              </div>
            </div>

            <!-- ‚úÖ Evaluation Button - permission 14 -->
            <div *ngIf="hasSpecificPermission(14) && canEvaluate">
              <button class="btn btn-sm btn-outline-warning w-100 mb-1" title="‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à"
                [disabled]="!canEvaluate || hasExistingSatisfaction">
                <i class="bi bi-star me-1"></i>
                <span *ngIf="!hasExistingSatisfaction">Evaluate</span>
                <span *ngIf="hasExistingSatisfaction">Evaluated</span>
              </button>
            </div>

            <!-- ‚úÖ Export Status in Quick Actions -->
            <div *ngIf="isExportingPdf" class="export-status mt-2">
              <div class="d-flex align-items-center text-info">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                <small>Generating PDF...</small>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- ‚úÖ Export Options Panel (Optional - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Advanced Users) -->
      <div class="export-options mt-3" *ngIf="hasPermission(1) && authService.hasAnyRole(['admin', 'supporter'])">
        <div class="card">
          <div class="card-header">
            <small><i class="bi bi-gear me-1"></i> Export Options</small>
          </div>
          <div class="card-body p-2">

            <!-- Export Format -->
            <div class="mb-2">
              <label class="form-label small">Format:</label>
              <select class="form-select form-select-sm" [(ngModel)]="exportOptions.format">
                <option value="summary">Summary Report</option>
                <option value="detailed">Detailed Report</option>
              </select>
            </div>

            <!-- Include Options -->
            <div class="form-check form-check-sm mb-1">
              <input class="form-check-input" type="checkbox" id="includeAttachments"
                [(ngModel)]="exportOptions.includeAttachments">
              <label class="form-check-label small" for="includeAttachments">
                Include Attachments
              </label>
            </div>

            <div class="form-check form-check-sm mb-1">
              <input class="form-check-input" type="checkbox" id="includeSolutionDetails"
                [(ngModel)]="exportOptions.includeSolutionDetails">
              <label class="form-check-label small" for="includeSolutionDetails">
                Include Solution Details
              </label>
            </div>

            <div class="form-check form-check-sm mb-2" *ngIf="hasSpecificPermission(14)">
              <input class="form-check-input" type="checkbox" id="includeSatisfactionRating"
                [(ngModel)]="exportOptions.includeSatisfactionRating">
              <label class="form-check-label small" for="includeSatisfactionRating">
                Include Satisfaction Rating
              </label>
            </div>

            <!-- Custom Export Button -->
            <button class="btn btn-sm btn-primary w-100" (click)="exportCustomPdf()" [disabled]="!canExportPdf()"
              title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î">
              <i class="bi bi-download me-1"></i>
              <span *ngIf="!isExportingPdf">Custom Export</span>
              <span *ngIf="isExportingPdf">Exporting...</span>
            </button>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ===== üÜï ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î ATTACHMENT PREVIEW MODAL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ===== -->
<div class="modal fade" [class.show]="showAttachmentModal" [style.display]="showAttachmentModal ? 'block' : 'none'"
  [style.z-index]="showAttachmentModal ? '99999' : 'auto'" tabindex="-1" role="dialog" *ngIf="showAttachmentModal">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content attachment-modal">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-file-earmark me-2"></i>
          {{ currentAttachment?.filename || 'Attachment Preview' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeAttachmentModal()"></button>
      </div>
      <div class="modal-body text-center">
        <!-- Image Preview -->
        <img *ngIf="isImageAttachment()" [src]="currentAttachment?.path" [alt]="currentAttachment?.filename"
          class="img-fluid attachment-preview-image">

        <!-- PDF Preview -->
        <iframe *ngIf="isPdfAttachment()" [src]="sanitizeUrl(currentAttachment?.path)"
          class="attachment-preview-iframe">
        </iframe>

        <!-- Other Files -->
        <div *ngIf="!isImageAttachment() && !isPdfAttachment()" class="attachment-preview-other">
          <i [class]="getFileIcon(currentAttachment?.path || '', currentAttachment?.attachment_id)"
            class="attachment-preview-icon"></i>
          <h4>{{ currentAttachment?.filename }}</h4>
          <p class="text-muted">{{ getFileTypeText() }}</p>
          <button class="btn btn-primary" (click)="downloadCurrentAttachment()">
            <i class="bi bi-download me-2"></i>
            Download File
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAttachmentModal()">
          Close
        </button>
        <button type="button" class="btn btn-primary" (click)="downloadCurrentAttachment()">
          <i class="bi bi-download me-2"></i>
          Download
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showAttachmentModal"
  [style.z-index]="showAttachmentModal ? '99998' : 'auto'" *ngIf="showAttachmentModal" (click)="closeAttachmentModal()">
</div>