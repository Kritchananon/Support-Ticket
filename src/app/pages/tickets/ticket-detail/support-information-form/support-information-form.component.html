<!-- Support Information Card -->
<div class="support-info-card">
    <!-- Support Header -->
    <div class="support-header">
        <h2 class="support-title">Support Information</h2>
        <!-- Debug controls for development -->
        <div class="debug-controls" *ngIf="false" style="margin-top: 0.5rem;">
            <button type="button" class="btn btn-outline-light btn-sm me-2" (click)="manualSaveFormData()"
                [disabled]="!hasFormData()">
                Manual Save
            </button>
            <button type="button" class="btn btn-outline-light btn-sm"
                (click)="debugLog('Debug Info:', getFormDebugInfo())">
                Debug Info
            </button>
        </div>
    </div>

    <!-- Loading State for Ticket Data -->
    <div class="text-center py-4" *ngIf="isLoadingTicketData">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
        <p class="text-muted mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ticket...</p>
        <small class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì</small>
    </div>

    <!-- Supporter Form Section -->
    <div id="supporterFormSection" class="supporter-form-section" *ngIf="canShowSupporterForm()">

        <!-- Form Data Persistence Status -->
        <div class="alert alert-success d-flex align-items-start"
            *ngIf="getFormPersistenceStatus().hasPersistedData && !isJustSaved && getFormPersistenceStatus().isValidForCurrentTicket"
            role="alert">
            <i class="bi bi-cloud-check me-2 mt-1"></i>
            <div>
                <strong>üîí ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</strong>
                <div class="mt-1">
                    <small class="text-muted">
                        ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ getFormPersistenceStatus().lastSaved | date:'dd/MM/yyyy HH:mm:ss' }}
                        <span *ngIf="getFormPersistenceStatus().dataAge < 60">
                            ({{ getFormPersistenceStatus().dataAge }} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß)
                        </span>
                        <span *ngIf="getFormPersistenceStatus().dataAge >= 60">
                            ({{ (getFormPersistenceStatus().dataAge / 60) | number:'1.0-0' }} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß)
                        </span>
                    </small>
                </div>
                <div class="mt-1">
                    <small class="text-success">
                        <i class="bi bi-shield-check me-1"></i>
                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </small>
                </div>
            </div>
        </div>

        <!-- Error/Success Messages -->
        <div class="alert alert-danger d-flex align-items-center" *ngIf="supporterFormState.error" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>{{ supporterFormState.error }}</div>
        </div>

        <div class="alert alert-success d-flex align-items-center" *ngIf="supporterFormState.successMessage"
            role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <div>{{ supporterFormState.successMessage }}</div>
        </div>

        <!-- Form Status Alert -->
        <div class="alert alert-info d-flex align-items-center" *ngIf="!isFormReady() && !isLoadingTicketData">
            <i class="bi bi-info-circle me-2"></i>
            <div>
                <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°:</strong> {{ getFormStatusMessage() }}
                <div class="mt-1" *ngIf="!ticketData?.ticket">
                    <small class="text-muted">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ticket ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</small>
                </div>
            </div>
        </div>

        <!-- Supporter Form -->
        <form class="supporter-form" [formGroup]="supporterForm" [class.form-disabled]="!isFormReady()"
            [class.form-saving]="supporterFormState.isSaving">

            <!-- Action Dropdown -->
            <div class="form-section">
                <div class="row g-3">

                    <!-- ‚úÖ Action Dropdown - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô col-md-6 -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Actions <span class="text-danger">*</span></label>

                            <!-- Loading State -->
                            <div *ngIf="isLoadingActions" class="form-control d-flex align-items-center">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</span>
                            </div>

                            <!-- Error State -->
                            <div *ngIf="actionError && !isLoadingActions" class="alert alert-warning p-2 mb-2"
                                role="alert">
                                <small class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    <span>{{ actionError }}</span>
                                    <button type="button" class="btn btn-outline-warning btn-sm ms-auto"
                                        (click)="refreshActionDropdown()" [disabled]="!isFormReady()"
                                        title="‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Action ‡πÉ‡∏´‡∏°‡πà">
                                        <i class="bi bi-arrow-clockwise me-1"></i>
                                        ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
                                    </button>
                                </small>
                            </div>

                            <!-- Action Dropdown -->
                            <select id="action" class="form-select" formControlName="action"
                                [class.is-invalid]="supporterForm.get('action')?.invalid && supporterForm.get('action')?.touched"
                                [disabled]="!isFormReady() || isLoadingActions || supporterFormState.isSaving"
                                *ngIf="!isLoadingActions">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Action...</option>
                                <option *ngFor="let option of actionDropdownOptions; trackBy: trackByActionOption"
                                    [value]="option.statusId" [disabled]="option.disabled">
                                    {{ option.label }}
                                </option>
                            </select>

                            <!-- Action Help Text -->
                            <small class="form-text text-muted" *ngIf="supporterForm.get('action')?.value">
                                ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Action ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ticket
                            </small>
                        </div>
                    </div>

                    <!-- ‚úÖ Priority Dropdown - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                    <div class="col-md-3" *ngIf="canUserChangePriority">
                        <div class="form-group">
                            <label>Priority</label>

                            <!-- Loading State -->
                            <div *ngIf="isLoadingPriorities" class="form-control d-flex align-items-center">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</span>
                            </div>

                            <!-- Error State -->
                            <div *ngIf="priorityError && !isLoadingPriorities" class="alert alert-warning p-2 mb-2"
                                role="alert">
                                <small class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    <span>{{ priorityError }}</span>
                                    <button type="button" class="btn btn-outline-warning btn-sm ms-auto"
                                        (click)="refreshPriorityDropdown()" [disabled]="!isFormReady()"
                                        title="‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Priority ‡πÉ‡∏´‡∏°‡πà">
                                        <i class="bi bi-arrow-clockwise me-1"></i>
                                        ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                                    </button>
                                </small>
                            </div>

                            <!-- Priority Dropdown -->
                            <select id="priority" class="form-select" formControlName="priority"
                                [disabled]="!isFormReady() || isLoadingPriorities || supporterFormState.isSaving"
                                *ngIf="!isLoadingPriorities && !priorityError">
                                <option [value]="null">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç...</option>
                                <option *ngFor="let option of priorityDropdownOptions; trackBy: trackByPriorityOption"
                                    [value]="option.id">
                                    {{ option.name }}
                                </option>
                            </select>

                            <!-- Priority Help Text -->
                            <small class="form-text text-muted">
                                ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á ticket (Low, Medium, High)
                            </small>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Date and Time Fields -->
            <div class="form-row">
                <div class="form-group">
                    <label>Close Estimate:</label>
                    <input type="datetime-local" id="close_estimate" class="form-control"
                        formControlName="close_estimate" [class.is-invalid]="hasFieldError('close_estimate')"
                        [disabled]="!isFormReady() || supporterFormState.isSaving">

                    <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ dirty/touched ‡πÅ‡∏•‡∏∞‡∏°‡∏µ error -->
                    <div *ngIf="supporterForm.get('close_estimate')?.dirty && hasFieldError('close_estimate')"
                        class="invalid-feedback">
                        {{ getFieldError('close_estimate') }}
                    </div>

                    <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á help text ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ error ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
                    <small class="form-text text-muted"
                        *ngIf="!supporterForm.get('close_estimate')?.dirty || !hasFieldError('close_estimate')">
                        ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                    </small>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label class="required">Estimate time:</label>
                    <input type="number" class="form-control" formControlName="estimate_time"
                        [class.is-invalid]="hasFieldError('estimate_time')" placeholder="‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á" min="0" max="1000"
                        [disabled]="!isFormReady() || supporterFormState.isSaving" readonly>
                    <div *ngIf="hasFieldError('estimate_time')" class="invalid-feedback">
                        {{ getFieldError('estimate_time') }}
                    </div>
                    <small class="text-success" *ngIf="estimateTime > 0 && !hasFieldError('estimate_time')">
                        <i class="bi bi-clock me-1"></i>
                        ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: {{ estimateTime }} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                    </small>
                    <small class="form-text text-muted" *ngIf="estimateTime === 0">
                        ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å Close Estimate
                    </small>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label>Due Date:</label>
                    <input type="datetime-local" id="due_date" class="form-control" formControlName="due_date"
                        [class.is-invalid]="hasFieldError('due_date')"
                        [disabled]="!isFormReady() || supporterFormState.isSaving">

                    <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ dirty/touched ‡πÅ‡∏•‡∏∞‡∏°‡∏µ error -->
                    <div *ngIf="supporterForm.get('due_date')?.dirty && hasFieldError('due_date')"
                        class="invalid-feedback">
                        {{ getFieldError('due_date') }}
                    </div>

                    <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á help text ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ error ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
                    <small class="form-text text-muted"
                        *ngIf="!supporterForm.get('due_date')?.dirty || !hasFieldError('due_date')">
                        ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô)
                    </small>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label class="required">Lead Time:</label>
                    <input type="number" class="form-control" formControlName="lead_time"
                        [class.is-invalid]="hasFieldError('lead_time')" placeholder="‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á" min="0" max="10000"
                        [disabled]="!isFormReady() || supporterFormState.isSaving" readonly>
                    <div *ngIf="hasFieldError('lead_time')" class="invalid-feedback">
                        {{ getFieldError('lead_time') }}
                    </div>
                    <small class="text-success" *ngIf="leadTime > 0 && !hasFieldError('lead_time')">
                        <i class="bi bi-clock me-1"></i>
                        ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: {{ leadTime }} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                    </small>
                    <small class="form-text text-muted" *ngIf="leadTime === 0">
                        ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å Due Date
                    </small>
                </div>
            </div>

            <!-- Assign and Related Tickets Section -->
            <div class="search-section">
                <!-- Assign Section -->
                <div class="form-group width-364" *ngIf="canAssignTicket()">
                    <label>Assign</label>

                    <!-- Loading State -->
                    <div *ngIf="isLoadingAssignees" class="form-control d-flex align-items-center">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</span>
                    </div>

                    <!-- Error State -->
                    <div *ngIf="assigneeError && !isLoadingAssignees" class="alert alert-warning p-2 mb-2" role="alert">
                        <small class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <span>{{ assigneeError }}</span>
                            <button type="button" class="btn btn-outline-warning btn-sm ms-auto"
                                (click)="refreshAssigneeList()" [disabled]="!isFormReady()"
                                title="‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                            </button>
                        </small>
                    </div>

                    <!-- Assign Dropdown -->
                    <select class="form-control select-field" [(ngModel)]="selectedAssigneeId"
                        [ngModelOptions]="{standalone: true}" (change)="onAssigneeChanged()"
                        [disabled]="!isFormReady() || !isAssigneeDropdownReady() || supporterFormState.isSaving"
                        *ngIf="!isLoadingAssignees && !assigneeError">
                        <option [ngValue]="null">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</option>
                        <option *ngFor="let user of assigneeList; trackBy: trackByUser" [ngValue]="user.id"
                            [selected]="user.id === selectedAssigneeId">
                            {{ getUserDisplayName(user) }}
                        </option>
                    </select>

                    <!-- Assignee Preview -->
                    <div *ngIf="getSelectedAssigneeName()" class="mt-2 p-2 bg-light rounded">
                        <small class="text-success d-flex align-items-center">
                            <i class="bi bi-person-check me-1"></i>
                            <strong>‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ:</strong>
                            <span class="ms-1">{{ getSelectedAssigneeName() }}</span>
                        </small>
                    </div>
                </div>

                <!-- Related Tickets Section -->
                <div class="form-group width-363">
                    <label>Related Tickets</label>
                    <input type="text" id="related_ticket_id" class="form-control" formControlName="related_ticket_id"
                        [class.is-invalid]="hasFieldError('related_ticket_id')"
                        placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ticket ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô T-001, T-002"
                        [disabled]="!isFormReady() || supporterFormState.isSaving">
                    <div *ngIf="hasFieldError('related_ticket_id')" class="invalid-feedback">
                        {{ getFieldError('related_ticket_id') }}
                    </div>
                    <small class="form-text text-muted" *ngIf="!hasFieldError('related_ticket_id')">
                        ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ticket ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    </small>
                </div>
            </div>

            <!-- Change Request Section -->
            <div class="form-section">
                <div class="form-group width-364">
                    <label>Change Request:</label>
                    <div class="input-field days-display">
                        <i class="bi bi-calendar-days me-2 text-muted"></i>
                        <span class="fw-bold">{{ ticketData?.ticket?.change_request || '0' }}</span>
                        <span class="unit-text">Days</span>
                    </div>
                    <small class="form-text text-muted">
                        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    </small>
                </div>
            </div>

            <!-- Issue Text Editor -->
            <div class="form-section">
                <div class="form-group">
                    <label class="required">Issue Resolution</label>
                    <div class="text-editor">
                        <div class="editor-toolbar">
                            <div class="toolbar-group">
                                <select class="toolbar-select" [disabled]="!isFormReady()">
                                    <option>Noto Sans Thai</option>
                                    <option>Arial</option>
                                    <option>Times New Roman</option>
                                </select>

                                <select class="toolbar-select" [disabled]="!isFormReady()">
                                    <option>14</option>
                                    <option>12</option>
                                    <option>16</option>
                                    <option>18</option>
                                </select>
                            </div>

                            <div class="toolbar-separator"></div>

                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" title="Bold" [disabled]="!isFormReady()">
                                    <strong>B</strong>
                                </button>
                                <div class="toolbar-separator"></div>
                                <button type="button" class="toolbar-btn" title="Italic" [disabled]="!isFormReady()">
                                    <em>I</em>
                                </button>
                                <div class="toolbar-separator"></div>
                                <button type="button" class="toolbar-btn" title="Underline" [disabled]="!isFormReady()">
                                    <u>U</u>
                                </button>
                                <div class="toolbar-separator"></div>
                                <button type="button" class="toolbar-btn active" title="Align Left"
                                    [disabled]="!isFormReady()">
                                    ‚â°
                                </button>
                                <div class="toolbar-separator"></div>
                                <button type="button" class="toolbar-btn" title="Align Center"
                                    [disabled]="!isFormReady()">
                                    ‚â°
                                </button>
                                <div class="toolbar-separator"></div>
                                <button type="button" class="toolbar-btn" title="Align Right"
                                    [disabled]="!isFormReady()">
                                    ‚â°
                                </button>
                            </div>
                        </div>

                        <textarea class="editor-content" formControlName="fix_issue_description"
                            [class.is-invalid]="hasFieldError('fix_issue_description')"
                            placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ..." maxlength="5000"
                            rows="6" [disabled]="!isFormReady() || supporterFormState.isSaving">
                        </textarea>

                        <div class="editor-footer p-2 bg-light d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                            </small>
                            <small class="text-muted">
                                {{ supporterForm.get('fix_issue_description')?.value?.length || 0 }}/5000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
                            </small>
                        </div>

                        <div *ngIf="hasFieldError('fix_issue_description')" class="invalid-feedback">
                            {{ getFieldError('fix_issue_description') }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attachment Section -->
            <div class="form-section">
                <div class="form-group">
                    <label>Attachment</label>

                    <div class="attachment-container" [class.dragover]="isDraggingFiles"
                        (dragover)="onAttachmentsDragOver($event)" (dragleave)="onAttachmentsDragLeave($event)"
                        (drop)="onAttachmentsDrop($event)">

                        <!-- ‡∏õ‡∏∏‡πà‡∏° Upload -->
                        <div class="attachment-upload-card"
                            (click)="isFormReady() && selectedFiles.length < maxFiles && fileInputNew.click()"
                            [class.disabled]="!isFormReady() || supporterFormState.isSaving || (existingFixAttachments.length + selectedFiles.length) >= maxFiles"
                            title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏≤‡∏Å‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
                            <i class="bi bi-plus-lg upload-icon"></i>
                            <span class="upload-label">Choose file</span>
                            <small class="text-muted" *ngIf="maxFiles">
                                ({{ existingFixAttachments.length + selectedFiles.length }}/{{ maxFiles }})
                            </small>
                        </div>

                        <!-- ‚úÖ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô container ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
                        <ng-container>
                            <!-- ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà -->
                            <app-file-list [attachments]="existingFixAttachments" [title]="'Support Attachments'"
                                [showTitle]="false" (fileClick)="onAttachmentClick($event)"
                                (fileDelete)="onExistingAttachmentDelete($event)">
                            </app-file-list>

                            <!-- ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î -->
                            <div *ngFor="let file of selectedFiles; let i = index; trackBy: trackByFile"
                                class="attachment-card new">
                                <button type="button" class="remove-attachment-btn" (click)="removeSelectedFile(i)"
                                    title="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <div class="attachment-preview">
                                    <img *ngIf="ticketService.isImageFile(file)" [src]="getFilePreview(file)"
                                        alt="Preview" class="attachment-img" />
                                    <div *ngIf="!ticketService.isImageFile(file)" class="attachment-icon-wrapper">
                                        <i [class]="ticketService.getFileIcon(file.name)" class="attachment-icon"></i>
                                        <span class="file-type-label">
                                            {{ getFileTypeFromExtension(file.name).toUpperCase() }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </ng-container>

                        <!-- Input File Hidden -->
                        <input #fileInputNew type="file" id="fileInputNew" (change)="onFileSelected($event)" multiple
                            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt,.xlsx,.csv" style="display: none;"
                            [disabled]="isFileLimitReached()" />
                    </div>

                    <small class="form-text text-muted mt-2 d-block">
                        ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å-‡πÅ‡∏•‡πâ‡∏ß-‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå (drag & drop) ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢ ‚Äî
                        ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: PDF, DOC, DOCX, JPG, PNG, GIF, TXT, XLSX, CSV
                    </small>
                </div>
            </div>


            <!-- Form Actions -->
            <div class="form-actions">
                <!-- ‡∏õ‡∏∏‡πà‡∏° Save ‡∏´‡∏•‡∏±‡∏Å -->
                <button type="button" class="save-btn" (click)="onSaveAll()" [disabled]="!canSaveAll()"
                    [class]="getSaveAllButtonClass()" [title]="getSaveAllButtonTooltip()">

                    <!-- Loading State -->
                    <span *ngIf="supporterFormState.isSaving">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
                    </span>

                    <!-- Normal State -->
                    <span *ngIf="!supporterFormState.isSaving">
                        <i class="bi me-2" [class.bi-floppy]="!selectedAssigneeId"
                            [class.bi-floppy2]="selectedAssigneeId && hasSupporterFormChanges()"
                            [class.bi-person-plus]="selectedAssigneeId && !hasSupporterFormChanges()">
                        </i>
                        {{ getSaveAllButtonText() }}
                    </span>
                </button>

                <!-- üÜï NEW: ‡∏õ‡∏∏‡πà‡∏° Manual Save (Optional - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö testing) -->
                <button type="button" class="btn btn-outline-info ms-2" (click)="persistAllFormData()"
                    [disabled]="!isFormReady() || !hasFormData()" *ngIf="false"
                    title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á LocalStorage ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ">
                    <i class="bi bi-cloud-arrow-up me-2"></i>
                    Force Save
                </button>

                <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏° -->
                <div class="form-status-info ms-auto d-flex align-items-center" *ngIf="!supporterFormState.isSaving">
                    <!-- üÜï ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Auto-save -->
                    <small class="text-success d-flex align-items-center me-3"
                        *ngIf="hasFormData() && getPersistedDataInfo()">
                        <i class="bi bi-cloud-check me-1"></i>
                        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                    </small>

                    <small class="text-muted d-flex align-items-center me-3">
                        <i class="bi me-1" [class.bi-circle-fill]="!hasFormData()"
                            [class.bi-circle-half]="hasFormData() && !canSaveAll()"
                            [class.bi-check-circle]="canSaveAll()" [class.text-secondary]="!hasFormData()"
                            [class.text-warning]="hasFormData() && !canSaveAll()" [class.text-success]="canSaveAll()">
                        </i>
                        <span *ngIf="!hasFormData()">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ß‡πà‡∏≤‡∏á</span>
                        <span *ngIf="hasFormData() && !canSaveAll()">‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                        <span *ngIf="canSaveAll()">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                    </small>
                </div>
            </div>
        </form>
    </div>

    <!-- No Permission Message -->
    <div class="text-center py-5" *ngIf="!canShowSupporterForm() && !isLoadingTicketData">
        <i class="bi bi-shield-exclamation text-muted" style="font-size: 4rem;"></i>
        <h5 class="text-muted mt-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
        <p class="text-muted">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå Supporter</p>
        <small class="text-muted">
            ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ permission: <strong>VIEW_ALL_TICKETS</strong>, <strong>CHANGE_STATUS</strong>, ‡∏´‡∏£‡∏∑‡∏≠
            <strong>ASSIGNEE</strong>
        </small>
    </div>

    <!-- Debug Section (‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô production) -->
    <div class="alert alert-warning mt-3" *ngIf="false" role="alert">
        <strong>üêõ Debug Mode</strong>
        <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-warning me-2" (click)="debugFormState()">
                <i class="bi bi-bug me-1"></i>
                Debug Form State
            </button>
            <button type="button" class="btn btn-sm btn-outline-info me-2" (click)="updateFormWithTicketData()">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Force Reload Form
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" (click)="loadTicketDataFromBackend()">
                <i class="bi bi-cloud-download me-1"></i>
                Reload from Backend
            </button>
        </div>
        <div class="mt-2">
            <small class="text-muted">
                Form Ready: {{ isFormReady() }} |
                Has Ticket: {{ hasTicketData() }} |
                Has Form Data: {{ hasFormData() }}
            </small>
        </div>
    </div>

    <!-- ‚úÖ File Preview Modal (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö Ticket Detail) -->
    <app-file-preview-modal [attachment]="selectedAttachment" [show]="showFileModal" (close)="closeModal()">
    </app-file-preview-modal>

</div>