<div class="ticket-list-page">
  <!-- Breadcrumb -->
  <div class="breadcrumb-container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a routerLink="/tickets">All Ticket</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Ticket</li>
      </ol>
    </nav>
  </div>

  <!-- ‚úÖ NEW: Status Loading Indicator -->
  <div *ngIf="isLoadingStatuses" class="status-loading mb-3">
    <div class="alert alert-info" role="alert">
      <span class="spinner-border spinner-border-sm me-2"></span>
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...
    </div>
  </div>

  <!-- ‚úÖ NEW: Status Error Indicator -->
  <div *ngIf="statusError && !isLoadingStatuses" class="status-error mb-3">
    <div class="alert alert-warning" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ statusError }}
      <button type="button" class="btn btn-sm btn-outline-warning ms-2" (click)="reloadStatusCache()">
        <i class="bi bi-arrow-clockwise me-1"></i>
        ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
      </button>
    </div>
  </div>

  <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Debug Info (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Development) -->
  <div *ngIf="!isLoading && tickets.length > 0" class="debug-info mb-3 d-none">
    <div class="alert alert-info">
      <strong>Debug:</strong> {{ getDebugInfo() | json }}
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <!-- ‚úÖ IMPROVED: Search Bar with Clear Button -->
    <div class="filter-item search-item">
      <label class="filter-label">Search</label>
      <div class="search-input-wrapper" [class.has-value]="searchText && searchText.trim()">
        <i class="bi bi-search search-icon"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search for ticket"
          [(ngModel)]="searchText"
          (input)="onSearchInput($event)"
          (keyup.enter)="applyFilters()"
          [value]="searchText">
        
        <!-- Clear search button -->
        <button 
          type="button" 
          class="clear-search-btn" 
          *ngIf="searchText && searchText.trim()"
          (click)="clearSearch()"
          title="Clear search">
          <i class="bi bi-x-circle-fill"></i>
        </button>
      </div>
    </div>

    <!-- Priority Filter -->
    <div class="filter-item priority-item">
      <label class="filter-label">Priority</label>
      <select class="filter-select" [value]="selectedPriority" (change)="onPriorityChange($event)">
        <option *ngFor="let option of priorityOptions" [value]="option.value">
          {{ option.label }}
        </option>
      </select>
    </div>

    <!-- ‚úÖ UPDATED: Status Filter - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å status cache -->
    <div class="filter-item status-item">
      <label class="filter-label">Status</label>
      <select class="filter-select" [value]="selectedStatus" (change)="onStatusChange($event)"
        [disabled]="isLoadingStatuses">

        <!-- Option ‡πÅ‡∏£‡∏Å‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° -->
        <option value="">All Status</option>

        <!-- ‚úÖ NEW: ‡πÅ‡∏™‡∏î‡∏á loading ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î status -->
        <option value="" *ngIf="isLoadingStatuses" disabled>Loading statuses...</option>

        <!-- ‚úÖ UPDATED: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å status cache ‡πÅ‡∏ó‡∏ô hardcode -->
        <option value="1">{{ getStatusText(1) }}</option>
        <option value="2">{{ getStatusText(2) }}</option>
        <option value="3">{{ getStatusText(3) }}</option>
        <option value="4">{{ getStatusText(4) }}</option>
        <option value="5">{{ getStatusText(5) }}</option>
        <option value="6">{{ getStatusText(6) }}</option>
      </select>
    </div>

    <!-- Categories Filter -->
    <div class="filter-item category-item">
      <label class="filter-label">Categories</label>
      <select class="filter-select" [value]="selectedCategory" (change)="onCategoryChange($event)"
        [disabled]="loadingFilters">
        <option value="">All Categories</option>
        <option *ngFor="let category of categories" [value]="category.id">
          {{ category.name }}
        </option>
      </select>
    </div>

    <!-- Project Filter -->
    <div class="filter-item project-item">
      <label class="filter-label">Project</label>
      <select class="filter-select" [value]="selectedProject" (change)="onProjectChange($event)"
        [disabled]="loadingFilters">
        <option value="">All Projects</option>
        <option *ngFor="let project of projects" [value]="project.id">
          {{ project.name }}
        </option>
      </select>
    </div>
  </div>

  <!-- ‚úÖ Debug button (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ development mode) -->
  <div class="debug-section mb-3" *ngIf="false">
    <button class="btn btn-sm btn-secondary" (click)="debugSearchData()">
      üêõ Debug Search
    </button>
  </div>

  <!-- ‚úÖ Filter Loading State -->
  <div *ngIf="loadingFilters" class="filter-loading">
    <div class="loading-message">
      <span class="spinner-border spinner-border-sm me-2"></span>
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• filter...
    </div>
  </div>

  <!-- ‚úÖ Filter Error State -->
  <div *ngIf="filterError && !loadingFilters" class="filter-error">
    <div class="alert alert-warning" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ filterError }}
      <button type="button" class="btn btn-sm btn-outline-warning ms-2" (click)="loadMasterFilters()">
        <i class="bi bi-arrow-clockwise me-1"></i>
        ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
      </button>
    </div>
  </div>

  <!-- ‚úÖ Tickets Error State -->
  <div *ngIf="ticketsError && !isLoading" class="tickets-error">
    <div class="alert alert-danger" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong> {{ ticketsError }}
      <button type="button" class="btn btn-sm btn-outline-danger ms-2" (click)="reloadTickets()">
        <i class="bi bi-arrow-clockwise me-1"></i>
        ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
      </button>
    </div>
  </div>

  <!-- ‚úÖ Loading State - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏´‡∏°‡∏∏‡∏ô -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="static-loading-indicator">
      <div class="loading-spinner"></div>
      <p class="static-loading-text">Loading tickets...</p>
    </div>
  </div>

  <!-- ‚úÖ No Tickets Found (‡πÉ‡∏´‡∏°‡πà) -->
  <div *ngIf="!isLoading && noTicketsFound && !ticketsError" class="no-tickets-found">
    <div class="no-results-content">
      <i class="bi bi-inbox no-results-icon"></i>
      <h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡πã‡∏ß</h3>
      <p>‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡πã‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
      <button class="btn btn-primary" (click)="createNewTicket()" *ngIf="canCreateTickets">
        <i class="bi bi-plus me-2"></i>
        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡πã‡∏ß‡πÉ‡∏´‡∏°‡πà
      </button>
    </div>
  </div>

  <!-- Tickets List -->
  <div *ngIf="!isLoading && !noTicketsFound" class="tickets-container">
    <!-- No Results from Filter -->
    <div *ngIf="filteredTickets.length === 0 && tickets.length > 0" class="no-results">
      <div class="no-results-content">
        <i class="bi bi-search no-results-icon"></i>
        <h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
        <p>‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</p>
        <button class="btn btn-primary" (click)="clearFilters()">
          <i class="bi bi-funnel me-2"></i>
          ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
        </button>
      </div>
    </div>

    <!-- Tickets Grid -->
    <div *ngIf="filteredTickets.length > 0" class="tickets-grid">
      <div *ngFor="let ticket of filteredTickets" class="ticket-card" (click)="viewTicket(ticket)">

        <!-- Ticket Header -->
        <div class="ticket-header">
          <div class="ticket-header-left">
            <div class="ticket-info">
              <span class="ticket-id">{{ ticket.ticket_no }}</span>
              <div class="ticket-divider"></div>
              <span class="ticket-category">{{ ticket.categories_name }}</span>
              <div class="ticket-divider" *ngIf="ticket.priority === 'high'"></div>
              <div class="priority-warning" *ngIf="ticket.priority === 'high'">
                <i class="bi bi-exclamation-triangle-fill priority-icon"></i>
                <div class="priority-tooltip">
                  <span class="priority-tooltip-text">Priority : High</span>
                  <div class="priority-tooltip-arrow"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="ticket-header-right">
            <div class="ticket-date-status">
              <span class="ticket-date">{{ formatDate(ticket.create_date) }}</span>
              <div class="ticket-divider"></div>

              <!-- ‚úÖ UPDATED: Status Badge - ‡πÉ‡∏ä‡πâ getStatusText() ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß -->
              <div class="status-badge" [ngClass]="getStatusBadgeClass(ticket.status_id)">
                <!-- ‚úÖ NEW: ‡πÅ‡∏™‡∏î‡∏á warning ‡∏ñ‡πâ‡∏≤ status cache ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î -->
                <i class="bi bi-exclamation-triangle text-warning me-1" *ngIf="!statusCacheLoaded && !isLoadingStatuses"
                  title="Status cache not loaded"></i>

                <i class="status-icon" [ngClass]="getStatusIcon(ticket.status_id)"></i>

                <!-- ‚úÖ UPDATED: ‡πÉ‡∏ä‡πâ getStatusText() ‡πÅ‡∏ó‡∏ô getStatusText() ‡πÄ‡∏î‡∏¥‡∏° -->
                <span class="status-text">{{ getStatusText(ticket.status_id) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Ticket Divider -->
        <div class="ticket-content-divider"></div>

        <!-- Ticket Content -->
        <div class="ticket-content">
          <div class="ticket-avatar">
            <div class="avatar-circle">
              <i class="bi bi-chat-dots-fill"></i>
            </div>
          </div>

          <div class="ticket-details">
            <div class="ticket-project-user">
              <h3 class="project-title">{{ ticket.project_name || 'Unknown Project' }}</h3>
              <div class="user-info">
                <i class="bi bi-person user-icon"></i>
                <span class="user-name">{{ ticket.user_name || 'Unknown User' }}</span>
              </div>
            </div>
            <p class="ticket-description">{{ ticket.issue_description }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Summary -->
    <div *ngIf="filteredTickets.length > 0" class="results-summary">
      <p>
        Showing {{ filteredTickets.length }} of {{ tickets.length }} tickets
        <span *ngIf="ticketsError" class="text-warning ms-2">
          <i class="bi bi-exclamation-triangle"></i>
          (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
        </span>
        <!-- ‚úÖ NEW: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á status cache -->
        <span *ngIf="!statusCacheLoaded && !isLoadingStatuses" class="text-muted ms-2">
          <i class="bi bi-info-circle"></i>
          (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
        </span>
      </p>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button class="fab-button" (click)="createNewTicket()" title="Create New Ticket" *ngIf="canCreateTickets">
    <i class="bi bi-plus"></i>
  </button>
</div>