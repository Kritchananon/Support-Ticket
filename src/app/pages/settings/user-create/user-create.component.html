<!-- Loading State -->
<div class="loading-container" *ngIf="isLoading">
  <div class="loading-spinner"></div>
  <div class="loading-text">
    {{ isEditMode ? 'Loading user data...' : 'Loading...' }}
  </div>
</div>

<!-- Main Content -->
<div class="user-create-page" *ngIf="!isLoading">
  
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <span class="breadcrumb-item inactive">Setting</span>
    <svg class="breadcrumb-separator" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
      <path d="M6.5 3L11 8l-4.5 5"/>
    </svg>
    <span class="breadcrumb-item inactive">User Account</span>
    <svg class="breadcrumb-separator" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
      <path d="M6.5 3L11 8l-4.5 5"/>
    </svg>
    <span class="breadcrumb-item active">{{ isEditMode ? 'Edit User' : 'Add User' }}</span>
  </div>

  <!-- Error Message -->
  <div class="alert alert-error" *ngIf="hasError">
    <svg class="alert-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
      <path d="M8 1C4.1 1 1 4.1 1 8s3.1 7 7 7 7-3.1 7-7-3.1-7-7-7zm3.5 10.5L10 13 8 11l-2 2-1.5-1.5L6 10 4 8l1.5-1.5L8 9l2-2 1.5 1.5L10 10l1.5 1.5z"/>
    </svg>
    {{ errorMessage }}
  </div>

  <!-- Success Message -->
  <div class="alert alert-success" *ngIf="successMessage">
    <svg class="alert-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
      <path d="M8 1C4.1 1 1 4.1 1 8s3.1 7 7 7 7-3.1 7-7-3.1-7-7-7zm3.5 5.5L7 11 4.5 8.5l1-1L7 9l3.5-3.5 1 1z"/>
    </svg>
    {{ successMessage }}
  </div>

  <!-- Form Container -->
  <div class="form-container">
    <h2 class="form-title">{{ pageTitle }}</h2>
    
    <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="user-form">
      
      <!-- Form Grid -->
      <div class="form-grid">
        
        <!-- First Name -->
        <div class="form-field">
          <label class="form-label">
            First Name <span class="required">*</span>
          </label>
          <input 
            type="text" 
            class="form-input"
            [class.error]="hasFieldError('firstname')"
            placeholder="Enter first name" 
            formControlName="firstname">
          <div class="field-error" *ngIf="hasFieldError('firstname')">
            {{ getFieldError('firstname') }}
          </div>
        </div>

        <!-- Last Name -->
        <div class="form-field">
          <label class="form-label">
            Last Name <span class="required">*</span>
          </label>
          <input 
            type="text" 
            class="form-input"
            [class.error]="hasFieldError('lastname')"
            placeholder="Enter last name" 
            formControlName="lastname">
          <div class="field-error" *ngIf="hasFieldError('lastname')">
            {{ getFieldError('lastname') }}
          </div>
        </div>

        <!-- Email -->
        <div class="form-field">
          <label class="form-label">
            Email <span class="required">*</span>
          </label>
          <input 
            type="email" 
            class="form-input"
            [class.error]="hasFieldError('email')"
            placeholder="Enter email address" 
            formControlName="email">
          <div class="field-error" *ngIf="hasFieldError('email')">
            {{ getFieldError('email') }}
          </div>
        </div>

        <!-- Phone Number -->
        <div class="form-field">
          <label class="form-label">
            Phone Number
          </label>
          <input 
            type="tel" 
            class="form-input"
            [class.error]="hasFieldError('phone')"
            placeholder="Enter phone number" 
            formControlName="phone">
          <div class="field-error" *ngIf="hasFieldError('phone')">
            {{ getFieldError('phone') }}
          </div>
        </div>

        <!-- Company -->
        <div class="form-field">
          <label class="form-label">
            Company <span class="required">*</span>
          </label>
          <input 
            type="text" 
            class="form-input"
            [class.error]="hasFieldError('company')"
            placeholder="Enter company name" 
            formControlName="company">
          <div class="field-error" *ngIf="hasFieldError('company')">
            {{ getFieldError('company') }}
          </div>
        </div>

        <!-- Company Address -->
        <div class="form-field">
          <label class="form-label">
            Company Address
          </label>
          <textarea 
            class="form-textarea"
            [class.error]="hasFieldError('companyAddress')"
            placeholder="Enter company address" 
            formControlName="companyAddress"
            rows="3"></textarea>
          <div class="field-error" *ngIf="hasFieldError('companyAddress')">
            {{ getFieldError('companyAddress') }}
          </div>
        </div>

        <!-- Project -->
        <div class="form-field">
          <label class="form-label">
            Project <span class="required">*</span>
          </label>
          <input 
            type="text" 
            class="form-input"
            [class.error]="hasFieldError('project')"
            placeholder="Enter project name" 
            formControlName="project">
          <div class="field-error" *ngIf="hasFieldError('project')">
            {{ getFieldError('project') }}
          </div>
        </div>

        <!-- Username -->
        <div class="form-field">
          <label class="form-label">
            Username <span class="required">*</span>
          </label>
          <div class="input-with-validation">
            <input 
              type="text" 
              class="form-input"
              [class.error]="hasFieldError('username')"
              [class.success]="usernameValidation.isValid && !isEditMode"
              placeholder="Enter username" 
              formControlName="username">
            
            <!-- Username validation feedback -->
            <div class="validation-feedback" *ngIf="!isEditMode">
              <div class="validation-checking" *ngIf="usernameValidation.isChecking">
                <div class="mini-spinner"></div>
                <span>Checking availability...</span>
              </div>
              <div class="validation-success" *ngIf="usernameValidation.isValid && !usernameValidation.isChecking">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 1C4.1 1 1 4.1 1 8s3.1 7 7 7 7-3.1 7-7-3.1-7-7-7zm3.5 5.5L7 11 4.5 8.5l1-1L7 9l3.5-3.5 1 1z"/>
                </svg>
                <span>{{ usernameValidation.message }}</span>
              </div>
              <div class="validation-error" *ngIf="!usernameValidation.isValid && usernameValidation.message && !usernameValidation.isChecking">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 1C4.1 1 1 4.1 1 8s3.1 7 7 7 7-3.1 7-7-3.1-7-7-7zm3.5 10.5L10 13 8 11l-2 2-1.5-1.5L6 10 4 8l1.5-1.5L8 9l2-2 1.5 1.5L10 10l1.5 1.5z"/>
                </svg>
                <span>{{ usernameValidation.message }}</span>
              </div>
            </div>
          </div>
          <div class="field-error" *ngIf="hasFieldError('username')">
            {{ getFieldError('username') }}
          </div>
        </div>

      </div>

      <!-- Password Fields (Only for Create Mode) -->
      <div class="form-grid" *ngIf="shouldShowPasswordFields">
        
        <!-- Password -->
        <div class="form-field">
          <label class="form-label">
            Password <span class="required">*</span>
          </label>
          <input 
            type="password" 
            class="form-input"
            [class.error]="hasFieldError('password')"
            placeholder="Enter password (min 8 characters)" 
            formControlName="password">
          <div class="field-error" *ngIf="hasFieldError('password')">
            {{ getFieldError('password') }}
          </div>
        </div>

        <!-- Confirm Password -->
        <div class="form-field">
          <label class="form-label">
            Confirm Password <span class="required">*</span>
          </label>
          <input 
            type="password" 
            class="form-input"
            [class.error]="hasFieldError('confirmPassword') || passwordMismatch"
            placeholder="Confirm password" 
            formControlName="confirmPassword">
          <div class="field-error" *ngIf="hasFieldError('confirmPassword')">
            {{ getFieldError('confirmPassword') }}
          </div>
          <div class="field-error" *ngIf="passwordMismatch && !hasFieldError('confirmPassword')">
            Passwords do not match
          </div>
        </div>

      </div>

      <!-- Roles Section (Only for Admin) -->
      <div class="form-field full-width" *ngIf="canAssignRoles()">
        <label class="form-label">
          Permissions <span class="required">*</span>
        </label>
        <div class="permissions-grid">
          <div class="permission-item" *ngFor="let role of availableRoles; trackBy: trackByRoleId">
            <label class="permission-checkbox">
              <input 
                type="checkbox" 
                [checked]="isRoleSelected(role)"
                (change)="onRoleChange(role, $event)">
              <span class="checkmark-permission"></span>
              <span class="permission-label">{{ getRoleDisplayName(role) }}</span>
            </label>
          </div>
        </div>
        <div *ngIf="availableRoles.length === 0" style="color: #666; font-style: italic; padding: 10px;">
          No roles available
        </div>
      </div>

      <!-- Enable/Disable User -->
      <div class="form-field full-width">
        <div class="checkbox-item">
          <label class="checkbox-container">
            <input type="checkbox" formControlName="isenabled">
            <span class="checkmark"></span>
            <span class="checkbox-label">Enable user account</span>
          </label>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button 
          type="button" 
          class="btn btn-secondary" 
          (click)="onCancel()"
          [disabled]="isSaving">
          Cancel
        </button>
        <button 
          type="submit" 
          class="btn btn-primary" 
          [disabled]="userForm.invalid || isSaving || (!usernameValidation.isValid && !isEditMode)">
          <span *ngIf="isSaving" class="btn-spinner"></span>
          {{ submitButtonText }}
        </button>
      </div>

    </form>
  </div>
</div>